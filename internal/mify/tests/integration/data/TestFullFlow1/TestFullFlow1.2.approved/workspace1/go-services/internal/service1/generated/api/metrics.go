// THIS FILE IS AUTOGENERATED, DO NOT EDIT
// Generated by mify via OpenAPI Generator

package openapi

import (
	"net/http"
	"time"

	"example.com/namespace/workspace1/go-services/internal/pkg/generated/metrics"
	"github.com/go-chi/chi/v5/middleware"
)

func Metrics() func(next http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		fn := func(w http.ResponseWriter, r *http.Request) {
			ww := middleware.NewWrapResponseWriter(w, r.ProtoMajor)

			ctxBuilder := mustGetContextBuilder(r)
			start := time.Now().UTC()

			next.ServeHTTP(ww, r)

			ctxBuilder.GetMetrics().ReportRequestEnd(
				metrics.RequestInfo{
					ServiceName: ctxBuilder.ServiceContext().ServiceName(),
					Hostname:    ctxBuilder.ServiceContext().Hostname(),
					URLPath:     ctxBuilder.GetURLPath(),
				},
				ww.Status(),
				time.Since(start),
				int(r.ContentLength),
				ww.BytesWritten())
		}
		return http.HandlerFunc(fn)
	}
}
